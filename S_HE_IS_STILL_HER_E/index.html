<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S/HE IS STILL HER/E</title>
    <link rel="icon" type="image/webp" href="./img/favi.webp">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Playfair+Display:ital@0;1&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Playfair+Display:ital@0;1&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Cormorant Garamond', 'Times New Roman', serif;
            background: #030306;
            color: rgba(255, 255, 255, 0.7);
        }

        .sky {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg,
                #0a0812 0%,
                #070610 40%,
                #030306 100%
            );
            transition: background 2.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }

        body.storm .sky {
            background: linear-gradient(180deg,
                #1a0508 0%,
                #120206 40%,
                #080003 100%
            );
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0.6;
            transition: opacity 2s ease;
        }

        body.storm .stars {
            opacity: 0.2;
        }

        .clouds-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            pointer-events: none;
            z-index: 2;
            opacity: 0.35;
            transition: opacity 2s ease, filter 2s ease;
        }

        body.storm .clouds-canvas {
            opacity: 0.5;
            filter: hue-rotate(-20deg) saturate(1.8) brightness(0.4);
        }

        .aurora {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background:
                radial-gradient(ellipse 80% 50% at 30% 20%, rgba(60, 20, 80, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 70% 30%, rgba(80, 30, 60, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 3;
            opacity: 0.5;
            animation: aurora-drift 20s ease-in-out infinite;
            transition: opacity 2s ease;
        }

        body.storm .aurora {
            opacity: 0;
        }

        @keyframes aurora-drift {
            0%, 100% { transform: translateX(-5%) rotate(-2deg); }
            50% { transform: translateX(5%) rotate(2deg); }
        }

        .red-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse 100% 70% at 50% 40%,
                rgba(120, 20, 40, 0.4) 0%,
                rgba(80, 10, 30, 0.2) 30%,
                transparent 60%
            );
            opacity: 0;
            pointer-events: none;
            z-index: 4;
            transition: opacity 2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.storm .red-glow {
            opacity: 1;
            animation: glow-pulse 3s ease-in-out infinite;
        }

        @keyframes glow-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 20%, rgba(0,0,0,0.7) 100%);
            pointer-events: none;
            z-index: 5;
            transition: background 2s ease;
        }

        body.storm .vignette {
            background: radial-gradient(ellipse at center, transparent 5%, rgba(0,0,0,0.9) 100%);
        }

        .ground-fog {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30%;
            background: linear-gradient(to top,
                rgba(15, 15, 25, 0.5) 0%,
                rgba(15, 15, 25, 0.2) 40%,
                transparent 100%
            );
            pointer-events: none;
            z-index: 6;
            transition: background 2s ease;
        }

        body.storm .ground-fog {
            background: linear-gradient(to top,
                rgba(50, 10, 20, 0.6) 0%,
                rgba(40, 5, 15, 0.3) 40%,
                transparent 100%
            );
        }

        #spectrumCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 7;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }

        .title {
            position: absolute;
            top: 48px;
            font-family: 'Playfair Display', serif;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: 6px;
            opacity: 0;
            transition: opacity 0.8s ease, color 2s ease, text-shadow 2s ease;
            color: rgba(255, 255, 255, 0.85);
            font-style: italic;
        }

        .title.visible {
            opacity: 0.95;
        }

        body.storm .title {
            color: #d4a0a8;
            text-shadow:
                0 0 40px rgba(180, 80, 100, 0.5),
                0 0 80px rgba(150, 50, 70, 0.3);
        }

        .subtitle {
            position: absolute;
            top: 78px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 11px;
            font-weight: 300;
            letter-spacing: 4px;
            opacity: 0;
            transition: opacity 0.8s ease 0.3s;
            color: rgba(255, 255, 255, 0.4);
            font-style: italic;
        }

        .title.visible + .subtitle,
        .subtitle.visible {
            opacity: 0.5;
        }

        body.storm .subtitle {
            color: rgba(180, 100, 120, 0.6);
        }

        .visualizer-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .whisper {
            position: absolute;
            font-family: 'Cormorant Garamond', serif;
            font-size: 13px;
            font-weight: 300;
            letter-spacing: 3px;
            opacity: 0;
            transition: opacity 1.2s ease;
            pointer-events: none;
            white-space: nowrap;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        .whisper.visible {
            opacity: 0.7;
        }

        body.storm .whisper {
            color: #d4a0a8;
            text-shadow: 0 0 20px rgba(180, 80, 100, 0.4);
        }

        .upload-hint {
            position: absolute;
            bottom: 48px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 12px;
            font-weight: 300;
            letter-spacing: 3px;
            opacity: 0.3;
            cursor: pointer;
            transition: opacity 0.5s ease, color 2s ease;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        .upload-hint:hover {
            opacity: 0.7;
        }

        .upload-hint.hidden {
            opacity: 0;
            pointer-events: none;
        }

        body.storm .upload-hint {
            color: rgba(180, 100, 120, 0.5);
        }

        #audioInput {
            display: none;
        }

        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .drag-overlay.active {
            display: flex;
        }

        .drag-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 13px;
            font-weight: 300;
            letter-spacing: 5px;
            opacity: 0.6;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        .silhouette {
            position: fixed;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 280px;
            opacity: 0;
            pointer-events: none;
            z-index: 8;
            transition: opacity 3s ease;
        }

        .silhouette-body {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 180px;
            background: linear-gradient(to top,
                #000 0%,
                #000 60%,
                transparent 100%
            );
            border-radius: 30px 30px 35px 35px;
            clip-path: polygon(
                30% 0%, 70% 0%,
                75% 15%, 80% 35%,
                75% 55%, 85% 100%,
                15% 100%, 25% 55%,
                20% 35%, 25% 15%
            );
        }

        .silhouette-head {
            position: absolute;
            bottom: 175px;
            left: 50%;
            transform: translateX(-50%);
            width: 35px;
            height: 45px;
            background: #000;
            border-radius: 50% 50% 45% 45%;
        }

        .silhouette-hair {
            position: absolute;
            bottom: 165px;
            left: 50%;
            transform: translateX(-50%);
            width: 55px;
            height: 100px;
            background: #000;
            border-radius: 50% 50% 40% 40%;
            clip-path: polygon(
                10% 30%, 50% 0%, 90% 30%,
                100% 60%, 95% 100%,
                5% 100%, 0% 60%
            );
        }

        body.storm .silhouette {
            opacity: 0.2;
        }

        .rose-petals {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9;
            overflow: hidden;
        }

        .petal {
            position: absolute;
            width: 12px;
            height: 10px;
            background: radial-gradient(ellipse at 30% 30%,
                rgba(180, 60, 80, 0.6) 0%,
                rgba(120, 30, 50, 0.4) 100%
            );
            border-radius: 50% 0% 50% 50%;
            opacity: 0;
            pointer-events: none;
            filter: blur(1px);
        }

        .grain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            opacity: 0.025;
            background-image: url('data:image/svg+xml,<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)"/></svg>');
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(3, 3, 6, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loading-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 13px;
            font-weight: 300;
            letter-spacing: 4px;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            margin-bottom: 20px;
        }

        .loading-bar {
            width: 200px;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .loading-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: rgba(200, 120, 140, 0.6);
            transition: width 0.3s ease;
        }

        .loading-detail {
            font-family: 'Cormorant Garamond', serif;
            font-size: 11px;
            font-weight: 300;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.3);
            font-style: italic;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="sky"></div>
    <div class="stars" id="stars"></div>
    <canvas class="clouds-canvas" id="cloudsCanvas"></canvas>
    <div class="aurora"></div>
    <div class="red-glow"></div>
    <div class="vignette"></div>
    <div class="ground-fog"></div>

    <canvas id="spectrumCanvas"></canvas>

    <div class="silhouette">
        <div class="silhouette-hair"></div>
        <div class="silhouette-head"></div>
        <div class="silhouette-body"></div>
    </div>

    <div class="rose-petals" id="petals"></div>
    <div class="grain"></div>

    <div class="container">
        <div class="title">S/HE IS STILL HER/E</div>


        <div class="visualizer-container">
        </div>

        <div class="upload-hint">Musik hier ablegen</div>
    </div>

    <div class="drag-overlay">
        <span class="drag-text">loslassen...</span>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-text">analysiere die Seele des Liedes...</div>
        <div class="loading-bar">
            <div class="loading-bar-fill" id="loadingBarFill"></div>
        </div>
        <div class="loading-detail" id="loadingDetail">wird vorbereitet...</div>
    </div>

    <input type="file" id="audioInput" accept="audio/*">
    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        const vis = {
            decay: 0.1,
            dbFloor: -70,
            dbCeil: -30,
            resolution: 8192,
            freqStart: 8,
            freqBands: 40,
            lowCutoff: 12,
            lowGain: 0.4,
            filterPasses: 1,
            filterWidth: 3,
            amplitude: 0.2,
            coreMin: 130,
            coreMax: 220,
            rings: 6,
            curve: [1, 1.12, 1.20, 1.30, 1.40, 1.50],
            blur: [0, 2, 2, 3, 4, 5],
            offset: [0, 1, 2, 3, 4, 5]
        };

        const PI_HALF = Math.PI * 0.5;
        const PI_2 = Math.PI * 2;

        const starsContainer = document.getElementById('stars');
        function createStars() {
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.style.cssText = `
                    position: absolute;
                    width: ${1 + Math.random() * 2}px;
                    height: ${1 + Math.random() * 2}px;
                    background: rgba(255, 255, 255, ${0.3 + Math.random() * 0.5});
                    border-radius: 50%;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 60}%;
                    animation: twinkle ${3 + Math.random() * 4}s ease-in-out infinite;
                    animation-delay: ${Math.random() * 3}s;
                `;
                starsContainer.appendChild(star);
            }
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes twinkle {
                0%, 100% { opacity: 0.3; }
                50% { opacity: 0.8; }
            }
        `;
        document.head.appendChild(style);
        createStars();

        const cloudsCanvas = document.getElementById('cloudsCanvas');
        const cloudsCtx = cloudsCanvas.getContext('2d');

        function resizeCloudsCanvas() {
            cloudsCanvas.width = window.innerWidth;
            cloudsCanvas.height = window.innerHeight * 0.6;
        }
        resizeCloudsCanvas();
        window.addEventListener('resize', resizeCloudsCanvas);

        const clouds = [];
        const CLOUD_COUNT = 10;

        class Cloud {
            constructor() {
                this.reset(true);
            }

            reset(initial = false) {
                this.width = 200 + Math.random() * 300;
                this.height = 50 + Math.random() * 70;
                this.x = initial ? Math.random() * cloudsCanvas.width : -this.width - 50;
                this.y = Math.random() * cloudsCanvas.height * 0.6;
                this.speed = 0.1 + Math.random() * 0.25;
                this.opacity = 0.12 + Math.random() * 0.18;
                this.blur = 25 + Math.random() * 35;

                this.parts = [];
                const partCount = 4 + Math.floor(Math.random() * 3);
                for (let i = 0; i < partCount; i++) {
                    this.parts.push({
                        offsetX: (i - partCount/2) * (this.width / partCount) * 0.5,
                        offsetY: (Math.random() - 0.5) * this.height * 0.3,
                        width: this.width * (0.35 + Math.random() * 0.35),
                        height: this.height * (0.5 + Math.random() * 0.5)
                    });
                }
            }

            update() {
                this.x += this.speed;
                if (this.x > cloudsCanvas.width + 100) {
                    this.reset();
                }
            }

            draw(ctx) {
                ctx.save();
                ctx.filter = `blur(${this.blur}px)`;
                ctx.globalAlpha = this.opacity;

                this.parts.forEach(part => {
                    ctx.beginPath();
                    ctx.ellipse(
                        this.x + part.offsetX,
                        this.y + part.offsetY,
                        part.width / 2,
                        part.height / 2,
                        0, 0, Math.PI * 2
                    );
                    ctx.fillStyle = 'rgba(160, 160, 180, 0.4)';
                    ctx.fill();
                });

                ctx.restore();
            }
        }

        for (let i = 0; i < CLOUD_COUNT; i++) {
            clouds.push(new Cloud());
        }

        function animateClouds() {
            cloudsCtx.clearRect(0, 0, cloudsCanvas.width, cloudsCanvas.height);
            clouds.forEach(cloud => {
                cloud.update();
                cloud.draw(cloudsCtx);
            });
            requestAnimationFrame(animateClouds);
        }
        animateClouds();

        let audioContext;
        let analyser;
        let dataArray;
        const audio = document.getElementById('audio');
        const title = document.querySelector('.title');
        const subtitle = document.querySelector('.subtitle');
        const uploadHint = document.querySelector('.upload-hint');
        const dragOverlay = document.querySelector('.drag-overlay');
        const audioInput = document.getElementById('audioInput');
        const container = document.querySelector('.container');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingBarFill = document.getElementById('loadingBarFill');
        const loadingDetail = document.getElementById('loadingDetail');

        const waveCanvas = document.getElementById('spectrumCanvas');
        const waveCtx = waveCanvas.getContext('2d');
        let frameHistory = [];
        const historyLen = Math.max(...vis.offset) + 1;

        function resizeWaveCanvas() {
            waveCanvas.width = window.innerWidth;
            waveCanvas.height = window.innerHeight;
        }
        resizeWaveCanvas();
        window.addEventListener('resize', resizeWaveCanvas);

        let isPlaying = false;

        function extractBands(raw) {
            let bands = raw.slice(vis.freqStart, vis.freqStart + vis.freqBands);
            return applyFilter(bands);
        }

        function getIntensity(bands) {
            let total = 0;
            const count = bands.length;
            const lowEnd = vis.lowCutoff - vis.freqStart;

            for (let i = 0; i < count; i++) {
                let w = 1.0;
                if (i < lowEnd) {
                    w = vis.lowGain + (1 - vis.lowGain) * (i / lowEnd);
                }
                total += bands[i] * w;
            }

            let norm = total / vis.freqBands / 256;
            let shaped = Math.pow(norm, 0.6);
            return Math.min(1, Math.max(0, 0.04 + shaped * 0.81));
        }

        function applyFilter(arr) {
            let src = arr;
            let out = [];
            for (let p = 0; p < vis.filterPasses; p++) {
                let half = Math.floor(vis.filterWidth / 2);
                let coef = 1 / (2 * half + 1);
                for (let i = 0; i < half; i++) {
                    out[i] = src[i];
                    out[src.length - i - 1] = src[src.length - i - 1];
                }
                for (let i = half; i < src.length - half; i++) {
                    let acc = 0;
                    for (let k = -half; k <= half; k++) {
                        acc += coef * src[i + k] + k;
                    }
                    out[i] = acc;
                }
                src = out;
            }
            return out;
        }

        function getCoreRadius(intensity) {
            return (intensity * (vis.coreMax - vis.coreMin) + vis.coreMin) / 2;
        }

        function blendBands(data, radius) {
            if (radius === 0) return data;
            const result = [];
            for (let i = 0; i < data.length; i++) {
                let acc = 0, weight = 0;
                for (let j = 0; j <= radius; j++) {
                    if (i - j < 0 || i + j > data.length - 1) break;
                    acc += data[i - j] + data[i + j];
                    weight += (radius - j + 1) * 2;
                }
                result[i] = acc / weight;
            }
            return result;
        }

        function renderWave(bands, intensity) {
            const ctx = waveCtx;
            const cx = window.innerWidth / 2;
            const cy = window.innerHeight / 2;

            if (frameHistory.length >= historyLen) frameHistory.shift();
            frameHistory.push(bands);

            const baseRadius = getCoreRadius(intensity);
            const opacities = [0.025, 0.022, 0.02, 0.028, 0.03, 0.032];

            for (let ring = vis.rings - 1; ring >= 0; ring--) {
                const frameIdx = Math.max(frameHistory.length - vis.offset[ring] - 1, 0);
                const ringBands = blendBands(frameHistory[frameIdx] || bands, vis.blur[ring]);
                const vertices = [];
                const count = ringBands.length;
                const ringRadius = baseRadius + ring * 3;

                for (let i = 0; i < count; i++) {
                    const angle = Math.PI * (i / (count - 1)) - PI_HALF;
                    let h = Math.pow(ringBands[i] * vis.amplitude, vis.curve[ring]);
                    h = Math.max(2, Math.min(100, h));
                    const dist = ringRadius + h;
                    vertices.push({ x: dist * Math.cos(angle), y: dist * Math.sin(angle) });
                }

                ctx.fillStyle = `rgba(255, 255, 255, ${opacities[ring]})`;
                ctx.shadowBlur = 0;
                tracePath(ctx, vertices, cx, cy, ringRadius);
            }
        }

        function tracePath(ctx, pts, cx, cy, inner) {
            if (!pts.length) return;
            ctx.beginPath();
            ctx.moveTo(cx, pts[0].y + cy);

            const n = pts.length;
            for (let i = 1; i < n - 2; i++) {
                const mx = (pts[i].x + pts[i + 1].x) / 2 + cx;
                const my = (pts[i].y + pts[i + 1].y) / 2 + cy;
                ctx.quadraticCurveTo(pts[i].x + cx, pts[i].y + cy, mx, my);
            }
            ctx.quadraticCurveTo(pts[n - 2].x + cx, pts[n - 2].y + cy, pts[n - 1].x + cx, pts[n - 1].y + cy);

            for (let i = n - 2; i >= 1; i--) {
                const mx = -(pts[i].x + pts[i - 1].x) / 2 + cx;
                const my = (pts[i].y + pts[i - 1].y) / 2 + cy;
                ctx.quadraticCurveTo(-pts[i].x + cx, pts[i].y + cy, mx, my);
            }
            ctx.quadraticCurveTo(-pts[0].x + cx, pts[0].y + cy, cx, pts[0].y + cy);

            ctx.moveTo(cx + inner, cy);
            ctx.arc(cx, cy, inner, 0, PI_2, true);
            ctx.fill();
        }

        let titleShown = false;
        document.addEventListener('mousemove', () => {
            if (!titleShown) {
                title.classList.add('visible');
                titleShown = true;
                setTimeout(() => {
                    if (!isPlaying) {
                        title.classList.remove('visible');
                    }
                }, 4000);
            }
        });

        uploadHint.addEventListener('click', () => {
            audioInput.click();
        });

        audioInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                loadAudio(e.target.files[0]);
            }
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragOverlay.classList.add('active');
        });

        document.addEventListener('dragleave', (e) => {
            if (e.relatedTarget === null) {
                dragOverlay.classList.remove('active');
            }
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            dragOverlay.classList.remove('active');

            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('audio/')) {
                loadAudio(file);
            }
        });

        async function loadAudio(file) {
            try {
                const url = URL.createObjectURL(file);
                audio.src = url;

                if (!audioContext) {
                    setupAudio();
                }

                frameHistory = [];

                audio.play().then(() => {
                    isPlaying = true;
                    uploadHint.classList.add('hidden');
                    title.classList.add('visible');
                });

            } catch (error) {
                console.error('Error loading audio:', error);
            }
        }

        function setupAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = vis.resolution;
            analyser.smoothingTimeConstant = vis.decay;
            analyser.minDecibels = vis.dbFloor;
            analyser.maxDecibels = vis.dbCeil;

            const source = audioContext.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);

            dataArray = new Uint8Array(analyser.frequencyBinCount);

            tick();
        }

        function tick() {
            requestAnimationFrame(tick);

            if (!isPlaying || !analyser) return;

            analyser.getByteFrequencyData(dataArray);

            const bands = extractBands(Array.from(dataArray));
            const intensity = getIntensity(bands);

            waveCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
            renderWave(bands, intensity);
        }

        audio.addEventListener('ended', () => {
            isPlaying = false;
            title.classList.remove('visible');
            uploadHint.classList.remove('hidden');
            waveCtx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && audio.src) {
                e.preventDefault();
                if (audio.paused) {
                    audio.play();
                    isPlaying = true;
                } else {
                    audio.pause();
                    isPlaying = false;
                }
            }
        });

        document.addEventListener('contextmenu', (e) => e.preventDefault());
    </script>
</body>
</html>
