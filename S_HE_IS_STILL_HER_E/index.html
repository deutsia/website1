<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="icon" type="image/webp" href="./img/favi.webp">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Playfair+Display:ital@0;1&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Playfair+Display:ital@0;1&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Cormorant Garamond', 'Times New Roman', serif;
            background: #030306;
            color: rgba(255, 255, 255, 0.7);
        }

        .sky {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg,
                #0a0812 0%,
                #070610 40%,
                #030306 100%
            );
            transition: background 2.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }

        body.storm .sky {
            background: linear-gradient(180deg,
                #1a0508 0%,
                #120206 40%,
                #080003 100%
            );
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0.6;
            transition: opacity 2s ease;
        }

        body.storm .stars {
            opacity: 0.2;
        }

        .clouds-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            pointer-events: none;
            z-index: 2;
            opacity: 0.35;
            transition: opacity 2s ease, filter 2s ease;
        }

        body.storm .clouds-canvas {
            opacity: 0.5;
            filter: hue-rotate(-20deg) saturate(1.8) brightness(0.4);
        }

        .aurora {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background:
                radial-gradient(ellipse 80% 50% at 30% 20%, rgba(60, 20, 80, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 70% 30%, rgba(80, 30, 60, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 3;
            opacity: 0.5;
            animation: aurora-drift 20s ease-in-out infinite;
            transition: opacity 2s ease;
        }

        body.storm .aurora {
            opacity: 0;
        }

        @keyframes aurora-drift {
            0%, 100% { transform: translateX(-5%) rotate(-2deg); }
            50% { transform: translateX(5%) rotate(2deg); }
        }

        .red-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse 100% 70% at 50% 40%,
                rgba(120, 20, 40, 0.4) 0%,
                rgba(80, 10, 30, 0.2) 30%,
                transparent 60%
            );
            opacity: 0;
            pointer-events: none;
            z-index: 4;
            transition: opacity 2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.storm .red-glow {
            opacity: 1;
            animation: glow-pulse 3s ease-in-out infinite;
        }

        @keyframes glow-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 20%, rgba(0,0,0,0.7) 100%);
            pointer-events: none;
            z-index: 5;
            transition: background 2s ease;
        }

        body.storm .vignette {
            background: radial-gradient(ellipse at center, transparent 5%, rgba(0,0,0,0.9) 100%);
        }

        .ground-fog {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30%;
            background: linear-gradient(to top,
                rgba(15, 15, 25, 0.5) 0%,
                rgba(15, 15, 25, 0.2) 40%,
                transparent 100%
            );
            pointer-events: none;
            z-index: 6;
            transition: background 2s ease;
        }

        body.storm .ground-fog {
            background: linear-gradient(to top,
                rgba(50, 10, 20, 0.6) 0%,
                rgba(40, 5, 15, 0.3) 40%,
                transparent 100%
            );
        }

        #spectrumCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 7;
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }

        .title {
            position: absolute;
            top: 48px;
            font-family: 'Playfair Display', serif;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: 6px;
            opacity: 0;
            transition: opacity 0.8s ease, color 2s ease, text-shadow 2s ease;
            color: rgba(255, 255, 255, 0.85);
            font-style: italic;
        }

        .title.visible {
            opacity: 0.95;
        }

        body.storm .title {
            color: #d4a0a8;
            text-shadow:
                0 0 40px rgba(180, 80, 100, 0.5),
                0 0 80px rgba(150, 50, 70, 0.3);
        }

        .subtitle {
            position: absolute;
            top: 78px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 11px;
            font-weight: 300;
            letter-spacing: 4px;
            opacity: 0;
            transition: opacity 0.8s ease 0.3s;
            color: rgba(255, 255, 255, 0.4);
            font-style: italic;
        }

        .title.visible + .subtitle,
        .subtitle.visible {
            opacity: 0.5;
        }

        body.storm .subtitle {
            color: rgba(180, 100, 120, 0.6);
        }

        .visualizer-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .whisper {
            position: absolute;
            font-family: 'Cormorant Garamond', serif;
            font-size: 13px;
            font-weight: 300;
            letter-spacing: 3px;
            opacity: 0;
            transition: opacity 1.2s ease;
            pointer-events: none;
            white-space: nowrap;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        .whisper.visible {
            opacity: 0.7;
        }

        body.storm .whisper {
            color: #d4a0a8;
            text-shadow: 0 0 20px rgba(180, 80, 100, 0.4);
        }

        .upload-hint {
            position: absolute;
            bottom: 48px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 12px;
            font-weight: 300;
            letter-spacing: 3px;
            opacity: 0.3;
            cursor: pointer;
            transition: opacity 0.5s ease, color 2s ease;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        .upload-hint:hover {
            opacity: 0.7;
        }

        .upload-hint.hidden {
            opacity: 0;
            pointer-events: none;
        }

        body.storm .upload-hint {
            color: rgba(180, 100, 120, 0.5);
        }

        #audioInput {
            display: none;
        }

        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .drag-overlay.active {
            display: flex;
        }

        .drag-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 13px;
            font-weight: 300;
            letter-spacing: 5px;
            opacity: 0.6;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        .silhouette {
            position: fixed;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 280px;
            opacity: 0;
            pointer-events: none;
            z-index: 8;
            transition: opacity 3s ease;
        }

        .silhouette-body {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 180px;
            background: linear-gradient(to top,
                #000 0%,
                #000 60%,
                transparent 100%
            );
            border-radius: 30px 30px 35px 35px;
            clip-path: polygon(
                30% 0%, 70% 0%,
                75% 15%, 80% 35%,
                75% 55%, 85% 100%,
                15% 100%, 25% 55%,
                20% 35%, 25% 15%
            );
        }

        .silhouette-head {
            position: absolute;
            bottom: 175px;
            left: 50%;
            transform: translateX(-50%);
            width: 35px;
            height: 45px;
            background: #000;
            border-radius: 50% 50% 45% 45%;
        }

        .silhouette-hair {
            position: absolute;
            bottom: 165px;
            left: 50%;
            transform: translateX(-50%);
            width: 55px;
            height: 100px;
            background: #000;
            border-radius: 50% 50% 40% 40%;
            clip-path: polygon(
                10% 30%, 50% 0%, 90% 30%,
                100% 60%, 95% 100%,
                5% 100%, 0% 60%
            );
        }

        body.storm .silhouette {
            opacity: 0.2;
        }

        .rose-petals {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9;
            overflow: hidden;
        }

        .petal {
            position: absolute;
            width: 12px;
            height: 10px;
            background: radial-gradient(ellipse at 30% 30%,
                rgba(180, 60, 80, 0.6) 0%,
                rgba(120, 30, 50, 0.4) 100%
            );
            border-radius: 50% 0% 50% 50%;
            opacity: 0;
            pointer-events: none;
            filter: blur(1px);
        }

        .grain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            opacity: 0.025;
            background-image: url('data:image/svg+xml,<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23noise)"/></svg>');
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(3, 3, 6, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loading-text {
            font-family: 'Cormorant Garamond', serif;
            font-size: 13px;
            font-weight: 300;
            letter-spacing: 4px;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            margin-bottom: 20px;
        }

        .loading-bar {
            width: 200px;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .loading-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: rgba(200, 120, 140, 0.6);
            transition: width 0.3s ease;
        }

        .loading-detail {
            font-family: 'Cormorant Garamond', serif;
            font-size: 11px;
            font-weight: 300;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.3);
            font-style: italic;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="sky"></div>
    <div class="stars" id="stars"></div>
    <canvas class="clouds-canvas" id="cloudsCanvas"></canvas>
    <div class="aurora"></div>
    <div class="red-glow"></div>
    <div class="vignette"></div>
    <div class="ground-fog"></div>

    <canvas id="spectrumCanvas"></canvas>

    <div class="silhouette">
        <div class="silhouette-hair"></div>
        <div class="silhouette-head"></div>
        <div class="silhouette-body"></div>
    </div>

    <div class="rose-petals" id="petals"></div>
    <div class="grain"></div>

    <div class="container">
        <div class="title">S/HE IS STILL HER/E</div>
        <div class="subtitle">im Namen der Liebe</div>

        <div class="visualizer-container">
        </div>

        <div class="upload-hint">Musik hier ablegen</div>
    </div>

    <div class="drag-overlay">
        <span class="drag-text">loslassen...</span>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-text">analysiere die Seele des Liedes...</div>
        <div class="loading-bar">
            <div class="loading-bar-fill" id="loadingBarFill"></div>
        </div>
        <div class="loading-detail" id="loadingDetail">wird vorbereitet...</div>
    </div>

    <input type="file" id="audioInput" accept="audio/*">
    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        const Config = {
            temporalSmoothing: 0.1,
            minDecibels: -70,
            maxDecibels: -30,
            fftSize: 8192,
            startBin: 8,
            keepBins: 40,
            sensitivityExponent: 0.5,
            bassAttenuationStart: 12,
            bassAttenuationFactor: 0.4,
            smoothingPasses: 1,
            smoothingPoints: 3,
            spectrumHeightScalar: 0.2,
            glowRadius: 15,
            minEmblemSize: 130,
            maxEmblemSize: 220,
            spectrumCount: 6,
            exponents: [1, 1.12, 1.20, 1.30, 1.40, 1.50],
            smoothMargins: [0, 2, 2, 3, 4, 5],
            delays: [0, 1, 2, 3, 4, 5]
        };

        const HALF_PI = Math.PI / 2;
        const TWO_PI = Math.PI * 2;

        function getResolutionMultiplier() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            return width >= height ? width / 1920 : height / 1080;
        }

        function random(min, max) {
            return Math.random() * (max - min) + min;
        }

        const starsContainer = document.getElementById('stars');
        function createStars() {
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.style.cssText = `
                    position: absolute;
                    width: ${1 + Math.random() * 2}px;
                    height: ${1 + Math.random() * 2}px;
                    background: rgba(255, 255, 255, ${0.3 + Math.random() * 0.5});
                    border-radius: 50%;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 60}%;
                    animation: twinkle ${3 + Math.random() * 4}s ease-in-out infinite;
                    animation-delay: ${Math.random() * 3}s;
                `;
                starsContainer.appendChild(star);
            }
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes twinkle {
                0%, 100% { opacity: 0.3; }
                50% { opacity: 0.8; }
            }
        `;
        document.head.appendChild(style);
        createStars();

        const cloudsCanvas = document.getElementById('cloudsCanvas');
        const cloudsCtx = cloudsCanvas.getContext('2d');

        function resizeCloudsCanvas() {
            cloudsCanvas.width = window.innerWidth;
            cloudsCanvas.height = window.innerHeight * 0.6;
        }
        resizeCloudsCanvas();
        window.addEventListener('resize', resizeCloudsCanvas);

        const clouds = [];
        const CLOUD_COUNT = 10;

        class Cloud {
            constructor() {
                this.reset(true);
            }

            reset(initial = false) {
                this.width = 200 + Math.random() * 300;
                this.height = 50 + Math.random() * 70;
                this.x = initial ? Math.random() * cloudsCanvas.width : -this.width - 50;
                this.y = Math.random() * cloudsCanvas.height * 0.6;
                this.speed = 0.1 + Math.random() * 0.25;
                this.opacity = 0.12 + Math.random() * 0.18;
                this.blur = 25 + Math.random() * 35;

                this.parts = [];
                const partCount = 4 + Math.floor(Math.random() * 3);
                for (let i = 0; i < partCount; i++) {
                    this.parts.push({
                        offsetX: (i - partCount/2) * (this.width / partCount) * 0.5,
                        offsetY: (Math.random() - 0.5) * this.height * 0.3,
                        width: this.width * (0.35 + Math.random() * 0.35),
                        height: this.height * (0.5 + Math.random() * 0.5)
                    });
                }
            }

            update() {
                this.x += this.speed;
                if (this.x > cloudsCanvas.width + 100) {
                    this.reset();
                }
            }

            draw(ctx) {
                ctx.save();
                ctx.filter = `blur(${this.blur}px)`;
                ctx.globalAlpha = this.opacity;

                this.parts.forEach(part => {
                    ctx.beginPath();
                    ctx.ellipse(
                        this.x + part.offsetX,
                        this.y + part.offsetY,
                        part.width / 2,
                        part.height / 2,
                        0, 0, Math.PI * 2
                    );
                    ctx.fillStyle = 'rgba(160, 160, 180, 0.4)';
                    ctx.fill();
                });

                ctx.restore();
            }
        }

        for (let i = 0; i < CLOUD_COUNT; i++) {
            clouds.push(new Cloud());
        }

        function animateClouds() {
            cloudsCtx.clearRect(0, 0, cloudsCanvas.width, cloudsCanvas.height);
            clouds.forEach(cloud => {
                cloud.update();
                cloud.draw(cloudsCtx);
            });
            requestAnimationFrame(animateClouds);
        }
        animateClouds();

        let audioContext;
        let analyser;
        let dataArray;
        const audio = document.getElementById('audio');
        const title = document.querySelector('.title');
        const subtitle = document.querySelector('.subtitle');
        const uploadHint = document.querySelector('.upload-hint');
        const dragOverlay = document.querySelector('.drag-overlay');
        const audioInput = document.getElementById('audioInput');
        const container = document.querySelector('.container');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingBarFill = document.getElementById('loadingBarFill');
        const loadingDetail = document.getElementById('loadingDetail');

        const spectrumCanvas = document.getElementById('spectrumCanvas');
        const spectrumCtx = spectrumCanvas.getContext('2d');
        let spectrumCache = [];
        const maxBufferSize = Math.max(...Config.delays) + 1;

        function resizeSpectrumCanvas() {
            spectrumCanvas.width = window.innerWidth;
            spectrumCanvas.height = window.innerHeight;
        }
        resizeSpectrumCanvas();
        window.addEventListener('resize', resizeSpectrumCanvas);

        let isPlaying = false;

        function transformSpectrum(spectrum) {
            let subArr = spectrum.slice(Config.startBin, Config.startBin + Config.keepBins);
            subArr = savitskyGolaySmooth(subArr);
            return subArr;
        }

        function calculateMultiplier(spectrum) {
            let sum = 0;
            const len = spectrum.length;
            const bassEnd = Config.bassAttenuationStart - Config.startBin;
            const bassFactor = Config.bassAttenuationFactor;

            for (let i = 0; i < len; i++) {
                let weight = 1.0;
                if (i < bassEnd) {
                    weight = bassFactor + (1 - bassFactor) * (i / bassEnd);
                }
                sum += spectrum[i] * weight;
            }

            let intermediate = sum / Config.keepBins / 256;
            let compressed = Math.pow(intermediate, 0.6);
            let boosted = 0.04 + compressed * 0.81;
            return Math.min(1, Math.max(0, boosted));
        }

        function savitskyGolaySmooth(array) {
            let lastArray = array;
            let newArr = [];
            for (let pass = 0; pass < Config.smoothingPasses; pass++) {
                let sidePoints = Math.floor(Config.smoothingPoints / 2);
                let cn = 1 / (2 * sidePoints + 1);
                for (let i = 0; i < sidePoints; i++) {
                    newArr[i] = lastArray[i];
                    newArr[lastArray.length - i - 1] = lastArray[lastArray.length - i - 1];
                }
                for (let i = sidePoints; i < lastArray.length - sidePoints; i++) {
                    let sum = 0;
                    for (let n = -sidePoints; n <= sidePoints; n++) {
                        sum += cn * lastArray[i + n] + n;
                    }
                    newArr[i] = sum;
                }
                lastArray = newArr;
            }
            return newArr;
        }

        function calcRadius(multiplier) {
            const minSize = Config.minEmblemSize;
            const maxSize = Config.maxEmblemSize;
            const scalar = multiplier * (maxSize - minSize) + minSize;
            return scalar / 2;
        }

        function smoothSpectrum(points, margin) {
            if (margin === 0) return points;

            const newArr = [];
            for (let i = 0; i < points.length; i++) {
                let sum = 0;
                let denom = 0;
                for (let j = 0; j <= margin; j++) {
                    if (i - j < 0 || i + j > points.length - 1) break;
                    sum += points[i - j] + points[i + j];
                    denom += (margin - j + 1) * 2;
                }
                newArr[i] = sum / denom;
            }
            return newArr;
        }

        function drawSpectrum(spectrum, multiplier) {
            const ctx = spectrumCtx;
            const halfWidth = window.innerWidth / 2;
            const halfHeight = window.innerHeight / 2;

            if (spectrumCache.length >= maxBufferSize) {
                spectrumCache.shift();
            }
            spectrumCache.push(spectrum);

            const curRad = calcRadius(multiplier);
            const minWaveHeight = 2;
            const maxWaveHeight = 100;

            const layerOpacities = [0.025, 0.022, 0.02, 0.028, 0.03, 0.032];

            for (let s = Config.spectrumCount - 1; s >= 0; s--) {
                const cacheIndex = Math.max(spectrumCache.length - Config.delays[s] - 1, 0);
                const curSpectrum = smoothSpectrum(spectrumCache[cacheIndex] || spectrum, Config.smoothMargins[s]);

                const points = [];
                const len = curSpectrum.length;

                const layerOffset = s * 3;
                const innerRad = curRad + layerOffset;

                for (let i = 0; i < len; i++) {
                    const t = Math.PI * (i / (len - 1)) - HALF_PI;
                    let waveHeight = Math.pow(curSpectrum[i] * Config.spectrumHeightScalar, Config.exponents[s]);
                    waveHeight = Math.max(waveHeight, minWaveHeight);
                    waveHeight = Math.min(waveHeight, maxWaveHeight);
                    const r = innerRad + waveHeight;
                    const x = r * Math.cos(t);
                    const y = r * Math.sin(t);
                    points.push({ x, y });
                }

                ctx.fillStyle = `rgba(255, 255, 255, ${layerOpacities[s]})`;
                ctx.shadowBlur = 0;
                drawSpectrumPoints(ctx, points, halfWidth, halfHeight, innerRad);
            }
        }

        function drawSpectrumPoints(ctx, points, halfWidth, halfHeight, innerRadius) {
            if (points.length === 0) return;

            ctx.beginPath();

            ctx.moveTo(halfWidth, points[0].y + halfHeight);
            const len = points.length;
            for (let i = 1; i < len - 2; i++) {
                const c = (points[i].x + points[i + 1].x) / 2 + halfWidth;
                const d = (points[i].y + points[i + 1].y) / 2 + halfHeight;
                ctx.quadraticCurveTo(points[i].x + halfWidth, points[i].y + halfHeight, c, d);
            }
            ctx.quadraticCurveTo(
                points[len - 2].x + halfWidth,
                points[len - 2].y + halfHeight,
                points[len - 1].x + halfWidth,
                points[len - 1].y + halfHeight
            );

            for (let i = len - 2; i >= 1; i--) {
                const c = -(points[i].x + points[i - 1].x) / 2 + halfWidth;
                const d = (points[i].y + points[i - 1].y) / 2 + halfHeight;
                ctx.quadraticCurveTo(-points[i].x + halfWidth, points[i].y + halfHeight, c, d);
            }
            ctx.quadraticCurveTo(-points[0].x + halfWidth, points[0].y + halfHeight, halfWidth, points[0].y + halfHeight);

            ctx.moveTo(halfWidth + innerRadius, halfHeight);
            ctx.arc(halfWidth, halfHeight, innerRadius, 0, TWO_PI, true);

            ctx.fill();
        }

        let titleShown = false;
        document.addEventListener('mousemove', () => {
            if (!titleShown) {
                title.classList.add('visible');
                titleShown = true;
                setTimeout(() => {
                    if (!isPlaying) {
                        title.classList.remove('visible');
                    }
                }, 4000);
            }
        });

        uploadHint.addEventListener('click', () => {
            audioInput.click();
        });

        audioInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                loadAudio(e.target.files[0]);
            }
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragOverlay.classList.add('active');
        });

        document.addEventListener('dragleave', (e) => {
            if (e.relatedTarget === null) {
                dragOverlay.classList.remove('active');
            }
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            dragOverlay.classList.remove('active');

            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('audio/')) {
                loadAudio(file);
            }
        });

        async function loadAudio(file) {
            try {
                const url = URL.createObjectURL(file);
                audio.src = url;

                if (!audioContext) {
                    initAudio();
                }

                spectrumCache = [];

                audio.play().then(() => {
                    isPlaying = true;
                    uploadHint.classList.add('hidden');
                    title.classList.add('visible');
                });

            } catch (error) {
                console.error('Error loading audio:', error);
            }
        }

        function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = Config.fftSize;
            analyser.smoothingTimeConstant = Config.temporalSmoothing;
            analyser.minDecibels = Config.minDecibels;
            analyser.maxDecibels = Config.maxDecibels;

            const source = audioContext.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);

            dataArray = new Uint8Array(analyser.frequencyBinCount);

            animateVisuals();
        }

        function animateVisuals() {
            requestAnimationFrame(animateVisuals);

            if (!isPlaying || !analyser) return;

            analyser.getByteFrequencyData(dataArray);

            const spectrum = transformSpectrum(Array.from(dataArray));
            const multiplier = calculateMultiplier(spectrum);

            spectrumCtx.clearRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);
            drawSpectrum(spectrum, multiplier);
        }

        audio.addEventListener('ended', () => {
            isPlaying = false;
            title.classList.remove('visible');
            uploadHint.classList.remove('hidden');
            spectrumCtx.clearRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && audio.src) {
                e.preventDefault();
                if (audio.paused) {
                    audio.play();
                    isPlaying = true;
                } else {
                    audio.pause();
                    isPlaying = false;
                }
            }
        });

        document.addEventListener('contextmenu', (e) => e.preventDefault());
    </script>
</body>
</html>
