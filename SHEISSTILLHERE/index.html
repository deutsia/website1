<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S/HE IS STILL HER/E</title>
    <link rel="icon" type="image/webp" href="../assets/favi.webp">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }

        body {
            background: linear-gradient(180deg,
                #1a1a2e 0%,
                #16213e 30%,
                #1a1a2e 60%,
                #0f0f1a 100%
            );
            color: rgba(255, 255, 255, 0.8);
            transition: background 0.8s ease, color 0.8s ease;
        }

        body.storm {
            background: linear-gradient(180deg,
                #0a0000 0%,
                #1a0505 30%,
                #2d0a0a 50%,
                #0a0000 100%
            );
            color: #c6181a;
        }

        .sky-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0.15;
            background:
                radial-gradient(ellipse 80% 50% at 20% 20%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 70% 30%, rgba(255,255,255,0.08) 0%, transparent 50%),
                radial-gradient(ellipse 90% 60% at 50% 80%, rgba(255,255,255,0.05) 0%, transparent 50%);
            transition: opacity 0.8s ease, filter 0.8s ease;
        }

        body.storm .sky-layer {
            opacity: 0.3;
            background:
                radial-gradient(ellipse 80% 50% at 20% 20%, rgba(198,24,26,0.2) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 70% 30%, rgba(139,0,0,0.15) 0%, transparent 50%),
                radial-gradient(ellipse 90% 60% at 50% 80%, rgba(198,24,26,0.1) 0%, transparent 50%);
            filter: blur(20px);
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }

        .title {
            position: absolute;
            top: 48px;
            font-size: 14px;
            letter-spacing: 4px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .title.visible {
            opacity: 0.8;
        }

        body.storm .title {
            color: #c6181a;
            text-shadow: 0 0 20px rgba(198,24,26,0.5);
        }

        .visualizer-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .circle {
            width: 120px;
            height: 120px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            transition: transform 0.08s ease-out, border-color 0.8s ease, box-shadow 0.8s ease;
            position: relative;
        }

        .circle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            transition: background 0.8s ease, box-shadow 0.8s ease;
        }

        body.storm .circle {
            border-color: #c6181a;
            box-shadow:
                0 0 60px rgba(198,24,26,0.6),
                0 0 120px rgba(198,24,26,0.3),
                inset 0 0 30px rgba(198,24,26,0.2);
        }

        body.storm .circle::before {
            background: #c6181a;
            box-shadow: 0 0 20px rgba(198,24,26,0.8);
        }

        .love-text {
            position: fixed;
            font-size: 10px;
            letter-spacing: 3px;
            color: rgba(255, 255, 255, 0.04);
            pointer-events: none;
            white-space: nowrap;
            transition: color 0.8s ease, opacity 0.8s ease, text-shadow 0.8s ease;
        }

        body.storm .love-text {
            color: rgba(198, 24, 26, 0.4);
            text-shadow: 0 0 10px rgba(198,24,26,0.3);
        }

        .whisper {
            position: absolute;
            font-size: 11px;
            letter-spacing: 2px;
            opacity: 0;
            transition: opacity 0.8s ease;
            pointer-events: none;
            white-space: nowrap;
        }

        .whisper.visible {
            opacity: 0.7;
        }

        body.storm .whisper {
            color: #c6181a;
            text-shadow: 0 0 10px rgba(198,24,26,0.5);
        }

        .upload-hint {
            position: absolute;
            bottom: 48px;
            font-size: 11px;
            letter-spacing: 2px;
            opacity: 0.3;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .upload-hint:hover {
            opacity: 0.8;
        }

        .upload-hint.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #audioInput {
            display: none;
        }

        .red-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(198,24,26,0.3) 0%, rgba(10,0,0,0.8) 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.5s ease;
        }

        body.storm .red-overlay {
            opacity: 1;
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.4) 100%);
            pointer-events: none;
            z-index: 6;
            transition: background 0.8s ease;
        }

        body.storm .vignette {
            background: radial-gradient(ellipse at center, transparent 20%, rgba(0,0,0,0.8) 100%);
        }

        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .drag-overlay.active {
            display: flex;
        }

        .drag-text {
            font-size: 12px;
            letter-spacing: 4px;
            opacity: 0.6;
        }

        .silhouette {
            position: fixed;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 250px;
            opacity: 0;
            pointer-events: none;
            z-index: 8;
            transition: opacity 1.5s ease;
        }

        .silhouette::before,
        .silhouette::after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 60px;
            height: 180px;
            background: #000;
            border-radius: 30px 30px 0 0;
        }

        .silhouette::before {
            left: 30px;
            transform: rotate(-5deg);
        }

        .silhouette::after {
            right: 30px;
            transform: rotate(5deg);
        }

        body.storm .silhouette {
            opacity: 0.15;
        }

        .reflection {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20%;
            background: linear-gradient(to bottom, transparent, rgba(198,24,26,0.1));
            opacity: 0;
            pointer-events: none;
            z-index: 4;
            transition: opacity 1s ease;
        }

        body.storm .reflection {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="sky-layer"></div>
    <div class="red-overlay"></div>
    <div class="vignette"></div>
    <div class="reflection"></div>
    <div class="silhouette"></div>

    <div class="container">
        <div class="title">S/HE IS STILL HER/E</div>

        <div class="visualizer-container">
            <div class="circle"></div>
        </div>

        <div class="upload-hint">drop audio or click</div>
    </div>

    <div class="drag-overlay">
        <span class="drag-text">release</span>
    </div>

    <input type="file" id="audioInput" accept="audio/*">
    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        const whispers = [
            'still here',
            'watching',
            'listening',
            'waiting',
            'remember',
            'always',
            'never',
            'remain',
            'linger',
            'together'
        ];

        const loveFragments = [
            'in the name of love',
            'in the name',
            'of love',
            'the name',
            'love',
            'name',
            'in the',
            'of'
        ];

        let audioContext;
        let analyser;
        let dataArray;
        let audio = document.getElementById('audio');
        let circle = document.querySelector('.circle');
        let title = document.querySelector('.title');
        let uploadHint = document.querySelector('.upload-hint');
        let dragOverlay = document.querySelector('.drag-overlay');
        let audioInput = document.getElementById('audioInput');
        let container = document.querySelector('.container');

        let isPlaying = false;
        let loveTexts = [];

        // Bass detection with rolling average
        const bassHistory = [];
        const bassHistoryLength = 30; // ~0.5 seconds of history at 60fps
        let longTermBassAvg = 0;
        let isInDrop = false;
        let dropStartTime = 0;
        let lastWhisperTime = 0;

        // Thresholds
        const DROP_ENTER_THRESHOLD = 1.8;  // Current bass must be 1.8x the long-term average
        const DROP_EXIT_THRESHOLD = 1.2;   // Exit when bass drops below 1.2x average
        const MIN_DROP_DURATION = 500;     // Minimum time in drop state (ms)
        const SUB_BASS_BINS = 4;           // Only look at first 4 bins (~0-170Hz)

        // Scatter "in the name of love" across the page
        function createLoveTexts() {
            const positions = [
                { x: 8, y: 15 },
                { x: 78, y: 10 },
                { x: 88, y: 40 },
                { x: 5, y: 50 },
                { x: 92, y: 65 },
                { x: 10, y: 80 },
                { x: 72, y: 88 },
                { x: 38, y: 95 },
                { x: 55, y: 8 },
                { x: 3, y: 30 },
                { x: 85, y: 85 },
                { x: 22, y: 70 }
            ];

            positions.forEach((pos, i) => {
                const el = document.createElement('div');
                el.className = 'love-text';
                el.textContent = loveFragments[i % loveFragments.length];
                el.style.left = pos.x + '%';
                el.style.top = pos.y + '%';
                el.style.transform = `rotate(${(Math.random() - 0.5) * 25}deg)`;
                document.body.appendChild(el);
                loveTexts.push(el);
            });
        }

        createLoveTexts();

        // Show title on first hover
        let titleShown = false;
        document.addEventListener('mousemove', () => {
            if (!titleShown) {
                title.classList.add('visible');
                titleShown = true;
                setTimeout(() => {
                    title.classList.remove('visible');
                }, 3000);
            }
        });

        // File input handling
        uploadHint.addEventListener('click', () => {
            audioInput.click();
        });

        audioInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                loadAudio(e.target.files[0]);
            }
        });

        // Drag and drop
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragOverlay.classList.add('active');
        });

        document.addEventListener('dragleave', (e) => {
            if (e.relatedTarget === null) {
                dragOverlay.classList.remove('active');
            }
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            dragOverlay.classList.remove('active');

            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('audio/')) {
                loadAudio(file);
            }
        });

        function loadAudio(file) {
            const url = URL.createObjectURL(file);
            audio.src = url;

            if (!audioContext) {
                initAudio();
            }

            audio.play().then(() => {
                isPlaying = true;
                uploadHint.classList.add('hidden');
                title.classList.add('visible');
            });
        }

        function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 512; // More resolution for better bass detection
            analyser.smoothingTimeConstant = 0.8;

            const source = audioContext.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);

            dataArray = new Uint8Array(analyser.frequencyBinCount);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);

            if (!isPlaying || !analyser) return;

            analyser.getByteFrequencyData(dataArray);

            // Get SUB-BASS only (first few bins, ~20-170Hz with 512 FFT at 44.1kHz)
            let subBassSum = 0;
            for (let i = 0; i < SUB_BASS_BINS; i++) {
                subBassSum += dataArray[i];
            }
            let currentBass = subBassSum / SUB_BASS_BINS;

            // Update rolling history
            bassHistory.push(currentBass);
            if (bassHistory.length > bassHistoryLength) {
                bassHistory.shift();
            }

            // Calculate long-term average (using full history)
            if (bassHistory.length > 0) {
                longTermBassAvg = bassHistory.reduce((a, b) => a + b, 0) / bassHistory.length;
            }

            // Scale circle based on current bass
            let scale = 1 + (currentBass / 255) * 0.6;
            circle.style.transform = `scale(${scale})`;

            // Detect bass drop state changes
            const now = Date.now();
            const bassRatio = longTermBassAvg > 10 ? currentBass / longTermBassAvg : 0;

            if (!isInDrop && bassRatio > DROP_ENTER_THRESHOLD && currentBass > 80) {
                // Enter drop
                enterDrop();
                dropStartTime = now;
            } else if (isInDrop) {
                // Check if we should exit drop
                const hasBeenInDropLongEnough = now - dropStartTime > MIN_DROP_DURATION;
                const bassDroppedOff = bassRatio < DROP_EXIT_THRESHOLD || currentBass < 50;

                if (hasBeenInDropLongEnough && bassDroppedOff) {
                    exitDrop();
                }

                // Spawn whispers during drop
                if (now - lastWhisperTime > 800 && Math.random() > 0.7) {
                    spawnWhisper();
                    lastWhisperTime = now;
                }
            }
        }

        function enterDrop() {
            isInDrop = true;
            document.body.classList.add('storm');
            title.classList.add('visible');
        }

        function exitDrop() {
            isInDrop = false;
            document.body.classList.remove('storm');
        }

        function spawnWhisper() {
            const whisper = document.createElement('div');
            whisper.className = 'whisper';
            whisper.textContent = whispers[Math.floor(Math.random() * whispers.length)];

            // Random position around the circle
            const angle = Math.random() * Math.PI * 2;
            const distance = 100 + Math.random() * 100;
            const x = Math.cos(angle) * distance;
            const y = Math.sin(angle) * distance;

            whisper.style.left = `calc(50% + ${x}px)`;
            whisper.style.top = `calc(50% + ${y}px)`;
            whisper.style.transform = `translate(-50%, -50%) rotate(${(Math.random() - 0.5) * 15}deg)`;

            container.appendChild(whisper);

            // Fade in
            setTimeout(() => whisper.classList.add('visible'), 50);

            // Fade out and remove
            setTimeout(() => {
                whisper.classList.remove('visible');
                setTimeout(() => whisper.remove(), 800);
            }, 2000 + Math.random() * 1000);
        }

        // Handle audio end
        audio.addEventListener('ended', () => {
            isPlaying = false;
            title.classList.remove('visible');
            uploadHint.classList.remove('hidden');
            exitDrop();
        });

        // Pause/play on space
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && audio.src) {
                e.preventDefault();
                if (audio.paused) {
                    audio.play();
                    isPlaying = true;
                } else {
                    audio.pause();
                    isPlaying = false;
                }
            }
        });

        // Prevent context menu
        document.addEventListener('contextmenu', (e) => e.preventDefault());
    </script>
</body>
</html>
