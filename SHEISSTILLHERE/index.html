<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S/HE IS STILL HER/E</title>
    <link rel="icon" type="image/webp" href="../assets/favi.webp">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Courier New', monospace;
        }

        body {
            background: linear-gradient(180deg,
                #87CEEB 0%,
                #B0E0E6 25%,
                #E0F6FF 50%,
                #F5F5DC 85%,
                #DEB887 100%
            );
            color: rgba(60, 60, 80, 0.8);
            transition: background 1.2s ease, color 1.2s ease;
        }

        body.storm {
            background: linear-gradient(180deg,
                #0a0000 0%,
                #1a0505 30%,
                #2d0a0a 50%,
                #0a0000 100%
            );
            color: #c6181a;
        }

        .clouds-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            overflow: hidden;
            pointer-events: none;
            z-index: 1;
        }

        .cloud {
            position: absolute;
            background: white;
            border-radius: 50%;
            filter: blur(2px);
            opacity: 0.9;
            transition: opacity 1.2s ease, filter 1.2s ease, background 1.2s ease;
        }

        body.storm .cloud {
            background: #1a0808;
            opacity: 0.6;
            filter: blur(8px);
        }

        .cloud::before,
        .cloud::after {
            content: '';
            position: absolute;
            background: inherit;
            border-radius: 50%;
        }

        .cloud-1 {
            width: 200px;
            height: 60px;
            top: 8%;
            animation: drift-1 25s linear infinite;
        }
        .cloud-1::before { width: 100px; height: 50px; top: -25px; left: 20px; }
        .cloud-1::after { width: 120px; height: 55px; top: -20px; left: 80px; }

        .cloud-2 {
            width: 150px;
            height: 45px;
            top: 18%;
            animation: drift-2 35s linear infinite;
            animation-delay: -10s;
        }
        .cloud-2::before { width: 80px; height: 40px; top: -20px; left: 15px; }
        .cloud-2::after { width: 90px; height: 45px; top: -18px; left: 60px; }

        .cloud-3 {
            width: 250px;
            height: 70px;
            top: 5%;
            animation: drift-3 40s linear infinite;
            animation-delay: -20s;
        }
        .cloud-3::before { width: 130px; height: 60px; top: -30px; left: 30px; }
        .cloud-3::after { width: 140px; height: 65px; top: -25px; left: 100px; }

        .cloud-4 {
            width: 180px;
            height: 50px;
            top: 25%;
            animation: drift-1 30s linear infinite;
            animation-delay: -5s;
        }
        .cloud-4::before { width: 90px; height: 45px; top: -22px; left: 25px; }
        .cloud-4::after { width: 100px; height: 48px; top: -20px; left: 75px; }

        .cloud-5 {
            width: 160px;
            height: 48px;
            top: 12%;
            animation: drift-2 28s linear infinite;
            animation-delay: -15s;
        }
        .cloud-5::before { width: 85px; height: 42px; top: -21px; left: 18px; }
        .cloud-5::after { width: 95px; height: 46px; top: -19px; left: 65px; }

        .cloud-6 {
            width: 220px;
            height: 65px;
            top: 3%;
            animation: drift-3 32s linear infinite;
            animation-delay: -8s;
            opacity: 0.7;
        }
        .cloud-6::before { width: 110px; height: 55px; top: -28px; left: 28px; }
        .cloud-6::after { width: 125px; height: 58px; top: -24px; left: 90px; }

        @keyframes drift-1 {
            from { left: -300px; }
            to { left: 110%; }
        }

        @keyframes drift-2 {
            from { left: -250px; }
            to { left: 115%; }
        }

        @keyframes drift-3 {
            from { left: -350px; }
            to { left: 105%; }
        }

        .horizon {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 15%;
            background: linear-gradient(180deg,
                transparent 0%,
                rgba(139, 119, 101, 0.1) 30%,
                rgba(139, 119, 101, 0.2) 100%
            );
            pointer-events: none;
            z-index: 2;
            transition: background 1.2s ease;
        }

        body.storm .horizon {
            background: linear-gradient(180deg,
                transparent 0%,
                rgba(198, 24, 26, 0.1) 30%,
                rgba(10, 0, 0, 0.4) 100%
            );
        }

        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }

        .title {
            position: absolute;
            top: 48px;
            font-size: 14px;
            letter-spacing: 4px;
            opacity: 0;
            transition: opacity 0.5s ease, color 1.2s ease;
            color: rgba(60, 60, 80, 0.9);
        }

        .title.visible {
            opacity: 0.9;
        }

        body.storm .title {
            color: #c6181a;
            text-shadow: 0 0 20px rgba(198,24,26,0.5);
        }

        .visualizer-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .circle {
            width: 120px;
            height: 120px;
            border: 1px solid rgba(60, 60, 80, 0.4);
            border-radius: 50%;
            transition: transform 0.08s ease-out, border-color 1.2s ease, box-shadow 1.2s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
        }

        .circle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 4px;
            background: rgba(60, 60, 80, 0.6);
            border-radius: 50%;
            transition: background 1.2s ease, box-shadow 1.2s ease;
        }

        body.storm .circle {
            border-color: #c6181a;
            background: rgba(198, 24, 26, 0.1);
            box-shadow:
                0 0 60px rgba(198,24,26,0.6),
                0 0 120px rgba(198,24,26,0.3),
                inset 0 0 30px rgba(198,24,26,0.2);
        }

        body.storm .circle::before {
            background: #c6181a;
            box-shadow: 0 0 20px rgba(198,24,26,0.8);
        }

        .love-text {
            position: fixed;
            font-size: 10px;
            letter-spacing: 3px;
            color: rgba(60, 60, 80, 0.06);
            pointer-events: none;
            white-space: nowrap;
            transition: color 1.2s ease, text-shadow 1.2s ease;
        }

        body.storm .love-text {
            color: rgba(198, 24, 26, 0.5);
            text-shadow: 0 0 10px rgba(198,24,26,0.3);
        }

        .whisper {
            position: absolute;
            font-size: 11px;
            letter-spacing: 2px;
            opacity: 0;
            transition: opacity 0.8s ease;
            pointer-events: none;
            white-space: nowrap;
            color: rgba(60, 60, 80, 0.8);
        }

        .whisper.visible {
            opacity: 0.7;
        }

        body.storm .whisper {
            color: #c6181a;
            text-shadow: 0 0 10px rgba(198,24,26,0.5);
        }

        .upload-hint {
            position: absolute;
            bottom: 48px;
            font-size: 11px;
            letter-spacing: 2px;
            opacity: 0.4;
            cursor: pointer;
            transition: opacity 0.3s ease, color 1.2s ease;
            color: rgba(60, 60, 80, 0.8);
        }

        .upload-hint:hover {
            opacity: 0.9;
        }

        .upload-hint.hidden {
            opacity: 0;
            pointer-events: none;
        }

        body.storm .upload-hint {
            color: rgba(198, 24, 26, 0.6);
        }

        #audioInput {
            display: none;
        }

        .red-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(198,24,26,0.2) 0%, rgba(10,0,0,0.85) 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.8s ease;
        }

        body.storm .red-overlay {
            opacity: 1;
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.15) 100%);
            pointer-events: none;
            z-index: 6;
            transition: background 1.2s ease;
        }

        body.storm .vignette {
            background: radial-gradient(ellipse at center, transparent 20%, rgba(0,0,0,0.85) 100%);
        }

        .drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(60, 60, 80, 0.2);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .drag-overlay.active {
            display: flex;
        }

        .drag-text {
            font-size: 12px;
            letter-spacing: 4px;
            opacity: 0.6;
            color: rgba(60, 60, 80, 0.8);
        }

        .silhouette {
            position: fixed;
            bottom: 8%;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 250px;
            opacity: 0;
            pointer-events: none;
            z-index: 8;
            transition: opacity 1.5s ease;
        }

        .silhouette::before,
        .silhouette::after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 60px;
            height: 180px;
            background: #000;
            border-radius: 30px 30px 0 0;
        }

        .silhouette::before {
            left: 30px;
            transform: rotate(-5deg);
        }

        .silhouette::after {
            right: 30px;
            transform: rotate(5deg);
        }

        body.storm .silhouette {
            opacity: 0.2;
        }

        .reflection {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 20%;
            background: linear-gradient(to bottom, transparent, rgba(198,24,26,0.15));
            opacity: 0;
            pointer-events: none;
            z-index: 4;
            transition: opacity 1.2s ease;
        }

        body.storm .reflection {
            opacity: 1;
        }

        /* Debug indicator - shows bass level */
        .debug-bar {
            position: fixed;
            bottom: 10px;
            left: 10px;
            width: 200px;
            height: 4px;
            background: rgba(0,0,0,0.2);
            z-index: 999;
            display: none;
        }

        .debug-bar-fill {
            height: 100%;
            background: #c6181a;
            width: 0%;
            transition: width 0.05s;
        }
    </style>
</head>
<body>
    <div class="clouds-container">
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <div class="cloud cloud-3"></div>
        <div class="cloud cloud-4"></div>
        <div class="cloud cloud-5"></div>
        <div class="cloud cloud-6"></div>
    </div>
    <div class="horizon"></div>
    <div class="red-overlay"></div>
    <div class="vignette"></div>
    <div class="reflection"></div>
    <div class="silhouette"></div>

    <div class="container">
        <div class="title">S/HE IS STILL HER/E</div>

        <div class="visualizer-container">
            <div class="circle"></div>
        </div>

        <div class="upload-hint">drop audio or click</div>
    </div>

    <div class="drag-overlay">
        <span class="drag-text">release</span>
    </div>

    <div class="debug-bar"><div class="debug-bar-fill"></div></div>

    <input type="file" id="audioInput" accept="audio/*">
    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        const whispers = [
            'still here',
            'watching',
            'listening',
            'waiting',
            'remember',
            'always',
            'never',
            'remain',
            'linger',
            'together'
        ];

        const loveFragments = [
            'in the name of love',
            'in the name',
            'of love',
            'the name',
            'love',
            'name',
            'in the',
            'of'
        ];

        let audioContext;
        let analyser;
        let dataArray;
        let audio = document.getElementById('audio');
        let circle = document.querySelector('.circle');
        let title = document.querySelector('.title');
        let uploadHint = document.querySelector('.upload-hint');
        let dragOverlay = document.querySelector('.drag-overlay');
        let audioInput = document.getElementById('audioInput');
        let container = document.querySelector('.container');

        let isPlaying = false;
        let loveTexts = [];

        // ===== NEW BASS DETECTION SYSTEM =====
        // Uses a very slow-updating baseline vs current reading

        let slowBaseline = 0;           // Very slow moving average (the "normal" level)
        let isInDrop = false;
        let dropStartTime = 0;
        let lastWhisperTime = 0;
        let frameCount = 0;

        // Key insight: We need to track what "quiet" sounds like vs what "loud" sounds like
        // The baseline should represent the quieter parts of the song

        const BASELINE_RISE_RATE = 0.002;    // Baseline rises VERY slowly when bass is high
        const BASELINE_FALL_RATE = 0.02;     // Baseline falls faster when bass is low
        const DROP_THRESHOLD_MULTIPLIER = 2.5; // Need 2.5x baseline to trigger drop
        const DROP_ABSOLUTE_MIN = 120;        // Minimum absolute bass level to trigger
        const EXIT_THRESHOLD_MULTIPLIER = 1.5; // Exit when below 1.5x baseline
        const MIN_DROP_DURATION = 800;        // Stay in drop for at least 800ms
        const BUILDUP_WINDOW = 90;            // ~1.5 seconds at 60fps

        // Buildup detection
        let energyHistory = [];
        let buildupDetected = false;

        // Scatter "in the name of love" across the page
        function createLoveTexts() {
            const positions = [
                { x: 8, y: 15 },
                { x: 78, y: 10 },
                { x: 88, y: 40 },
                { x: 5, y: 50 },
                { x: 92, y: 65 },
                { x: 10, y: 80 },
                { x: 72, y: 88 },
                { x: 38, y: 95 },
                { x: 55, y: 8 },
                { x: 3, y: 30 },
                { x: 85, y: 85 },
                { x: 22, y: 70 }
            ];

            positions.forEach((pos, i) => {
                const el = document.createElement('div');
                el.className = 'love-text';
                el.textContent = loveFragments[i % loveFragments.length];
                el.style.left = pos.x + '%';
                el.style.top = pos.y + '%';
                el.style.transform = `rotate(${(Math.random() - 0.5) * 25}deg)`;
                document.body.appendChild(el);
                loveTexts.push(el);
            });
        }

        createLoveTexts();

        // Show title on first hover
        let titleShown = false;
        document.addEventListener('mousemove', () => {
            if (!titleShown) {
                title.classList.add('visible');
                titleShown = true;
                setTimeout(() => {
                    title.classList.remove('visible');
                }, 3000);
            }
        });

        // File input handling
        uploadHint.addEventListener('click', () => {
            audioInput.click();
        });

        audioInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                loadAudio(e.target.files[0]);
            }
        });

        // Drag and drop
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragOverlay.classList.add('active');
        });

        document.addEventListener('dragleave', (e) => {
            if (e.relatedTarget === null) {
                dragOverlay.classList.remove('active');
            }
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            dragOverlay.classList.remove('active');

            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('audio/')) {
                loadAudio(file);
            }
        });

        function loadAudio(file) {
            const url = URL.createObjectURL(file);
            audio.src = url;

            if (!audioContext) {
                initAudio();
            }

            // Reset detection state for new track
            slowBaseline = 0;
            energyHistory = [];
            buildupDetected = false;
            isInDrop = false;

            audio.play().then(() => {
                isPlaying = true;
                uploadHint.classList.add('hidden');
                title.classList.add('visible');
            });
        }

        function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;  // Higher resolution
            analyser.smoothingTimeConstant = 0.4;  // Less smoothing for faster response

            const source = audioContext.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);

            dataArray = new Uint8Array(analyser.frequencyBinCount);

            animate();
        }

        function getSubBass() {
            // With 2048 FFT at 44100Hz, each bin is ~21.5Hz
            // Bins 1-4 cover roughly 21-86Hz (sub bass)
            // Bin 0 is often DC offset, skip it
            let sum = 0;
            for (let i = 1; i <= 4; i++) {
                sum += dataArray[i];
            }
            return sum / 4;
        }

        function getBass() {
            // Bins 5-12 cover roughly 86-258Hz (bass)
            let sum = 0;
            for (let i = 5; i <= 12; i++) {
                sum += dataArray[i];
            }
            return sum / 8;
        }

        function getMids() {
            // Higher frequencies for detecting snares/hi-hats
            let sum = 0;
            for (let i = 20; i <= 60; i++) {
                sum += dataArray[i];
            }
            return sum / 40;
        }

        function animate() {
            requestAnimationFrame(animate);

            if (!isPlaying || !analyser) return;

            analyser.getByteFrequencyData(dataArray);
            frameCount++;

            const subBass = getSubBass();
            const bass = getBass();
            const mids = getMids();

            // Combined low frequency energy (what we care about for drops)
            const lowEnergy = (subBass * 2 + bass) / 3;  // Weight sub-bass more heavily

            // Update energy history for buildup detection
            energyHistory.push(lowEnergy);
            if (energyHistory.length > BUILDUP_WINDOW) {
                energyHistory.shift();
            }

            // Scale circle based on low energy
            let scale = 1 + (lowEnergy / 255) * 0.7;
            circle.style.transform = `scale(${scale})`;

            // Update baseline asymmetrically:
            // - Rises very slowly when energy is high (so sustained bass doesn't raise it much)
            // - Falls faster when energy is low (so it returns to "quiet" level)
            if (lowEnergy > slowBaseline) {
                slowBaseline += (lowEnergy - slowBaseline) * BASELINE_RISE_RATE;
            } else {
                slowBaseline += (lowEnergy - slowBaseline) * BASELINE_FALL_RATE;
            }

            // Don't let baseline go below a minimum
            slowBaseline = Math.max(slowBaseline, 20);

            // Detect buildup: energy steadily increasing over time
            if (energyHistory.length >= BUILDUP_WINDOW) {
                const firstHalf = energyHistory.slice(0, BUILDUP_WINDOW / 2);
                const secondHalf = energyHistory.slice(BUILDUP_WINDOW / 2);
                const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
                const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;

                // Buildup detected if second half is significantly higher than first
                buildupDetected = secondAvg > firstAvg * 1.3 && secondAvg > 60;
            }

            const now = Date.now();

            // Calculate how much louder current bass is vs baseline
            const bassRatio = lowEnergy / Math.max(slowBaseline, 1);

            // Extra check: make sure it's actually bass, not just mids (snares)
            // If mids are proportionally louder than bass, it's probably not a real drop
            const isTrueBass = lowEnergy > mids * 0.8;

            if (!isInDrop) {
                // Enter drop conditions:
                // 1. Bass ratio exceeds threshold OR we detected a buildup and now have high bass
                // 2. Absolute bass level is high enough
                // 3. It's actually bass, not snares
                const ratioTrigger = bassRatio > DROP_THRESHOLD_MULTIPLIER;
                const buildupTrigger = buildupDetected && lowEnergy > 100;
                const absoluteTrigger = lowEnergy > DROP_ABSOLUTE_MIN;

                if ((ratioTrigger || buildupTrigger) && absoluteTrigger && isTrueBass) {
                    enterDrop();
                    dropStartTime = now;
                    buildupDetected = false;
                }
            } else {
                // Check if we should exit drop
                const hasBeenInDropLongEnough = now - dropStartTime > MIN_DROP_DURATION;
                const bassDroppedOff = bassRatio < EXIT_THRESHOLD_MULTIPLIER && lowEnergy < 80;

                if (hasBeenInDropLongEnough && bassDroppedOff) {
                    exitDrop();
                }

                // Spawn whispers during drop
                if (now - lastWhisperTime > 600 && Math.random() > 0.6) {
                    spawnWhisper();
                    lastWhisperTime = now;
                }
            }

            // Debug: uncomment to see bass level
            // document.querySelector('.debug-bar').style.display = 'block';
            // document.querySelector('.debug-bar-fill').style.width = (lowEnergy / 255 * 100) + '%';
        }

        function enterDrop() {
            isInDrop = true;
            document.body.classList.add('storm');
            title.classList.add('visible');
        }

        function exitDrop() {
            isInDrop = false;
            document.body.classList.remove('storm');
        }

        function spawnWhisper() {
            const whisper = document.createElement('div');
            whisper.className = 'whisper';
            whisper.textContent = whispers[Math.floor(Math.random() * whispers.length)];

            // Random position around the circle
            const angle = Math.random() * Math.PI * 2;
            const distance = 100 + Math.random() * 100;
            const x = Math.cos(angle) * distance;
            const y = Math.sin(angle) * distance;

            whisper.style.left = `calc(50% + ${x}px)`;
            whisper.style.top = `calc(50% + ${y}px)`;
            whisper.style.transform = `translate(-50%, -50%) rotate(${(Math.random() - 0.5) * 15}deg)`;

            container.appendChild(whisper);

            // Fade in
            setTimeout(() => whisper.classList.add('visible'), 50);

            // Fade out and remove
            setTimeout(() => {
                whisper.classList.remove('visible');
                setTimeout(() => whisper.remove(), 800);
            }, 2000 + Math.random() * 1000);
        }

        // Handle audio end
        audio.addEventListener('ended', () => {
            isPlaying = false;
            title.classList.remove('visible');
            uploadHint.classList.remove('hidden');
            exitDrop();
        });

        // Pause/play on space
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && audio.src) {
                e.preventDefault();
                if (audio.paused) {
                    audio.play();
                    isPlaying = true;
                } else {
                    audio.pause();
                    isPlaying = false;
                }
            }
        });

        // Prevent context menu
        document.addEventListener('contextmenu', (e) => e.preventDefault());
    </script>
</body>
</html>
